---
title: "HW2_R"
author: "GrantHe"
ID: "2154177"
date: "2023-11-12"
documentclass: ctexart
output:
  rticles::ctex:
    fig_caption: yes
geometry:
- tmargin=1cm
- bmargin=1cm
- lmargin=1cm
- rmargin=1cm
---

```{r}
# 当前工作项目，方便检查位置
getwd()
```
```{r}
install.packages("reshape2")
```

```{r}
library(ggplot2)
library(dplyr)
library(reshape2)
library(stats)
library(tidyr)

```

导入数据集,这里的数据是原始数据
```{r}
# 导入数据集
data <- read.csv("./stock.csv")

# 将日期列中的-替换为/
data$Date <- gsub("-", "/", data$Date)

# 转换Date列为日期格式
data$Date <- as.Date(data$Date, format = "%m/%d/%Y")

# 查看数据集的结构和前几行数据
str(data)
head(data)
```
```{r}
unique_companies = unique(data$Company)
print(unique_companies)
```



```{r 数据预处理}
# 移除$符号并将 股价 列转换为数值型
data$Close.Last <- as.numeric(gsub("\\$", "", data$Close.Last))
data$Open <- as.numeric(gsub("\\$", "", data$Open))
data$High <- as.numeric(gsub("\\$", "", data$High))
data$Low <- as.numeric(gsub("\\$", "", data$Low))

# 热图：重构造数据为年-月格式
data$Year <- format(data$Date, "%Y")
data$Month <- format(data$Date, "%m")

```


```{r}
# 公司列表
companies <- c("AAPL", "SBUX", "MSFT", "CSCO", "QCOM", "META", "AMZN", "TSLA", "AMD", "NFLX")

# 遍历每个公司，绘制散点图
for (company in companies) {
  # 筛选特定公司的数据
  company_data <- data[data$Company == company, ]

  # 使用ggplot2绘制散点图
  p <- ggplot(company_data, aes(x = Date, y = Close.Last)) +
    geom_point(alpha = 0.5) +
    scale_y_continuous(breaks = scales::pretty_breaks(n = 30)) +
    theme_minimal() +
    labs(title = paste(company, "Stock Price Scatter Plot"), 
         x = "Date", 
         y = "Close Last")

  # 打印散点图
  print(p)
}

```


```{r}
# 公司列表
companies <- c("AAPL", "SBUX", "MSFT", "CSCO", "QCOM", "META", "AMZN", "TSLA", "AMD", "NFLX")

# 遍历每个公司，计算月平均值并绘制热图
for (company in companies) {
  # 筛选特定公司的数据
  company_data <- data[data$Company == company, ]

  # 计算每月平均股价
  monthly_avg <- aggregate(Close.Last ~ Year + Month, company_data, mean)

  # 转换数据格式
  heatmap_data <- dcast(monthly_avg, Year ~ Month, value.var = "Close.Last")

  # 绘制热图
  p <- ggplot(melt(heatmap_data, id.vars = 'Year'), aes(x = variable, y = Year, fill = value)) +
    geom_tile() +
    scale_fill_gradient(low = "blue", high = "red") +
    theme_minimal() +
    labs(title = paste(company, "Monthly Average Stock Price Heatmap"), 
         x = "Month", 
         y = "Year")

  # 打印热图
  print(p)
}
```

```{r}
data_selected <- data %>%
  select(Date, Company, Close.Last)

# 使用spread函数将数据转换为宽格式
data_wide <- data_selected %>%
  spread(key = Company, value = Close.Last)

# 查看转换后的数据
head(data_wide)
```
```{r}
# 计算相关系数矩阵
cor_matrix <- cor(data_wide[, -1], use = "complete.obs")  # 假设第一列是日期

# 查看相关系数矩阵
print(cor_matrix)

```

```{r}
# 将相关系数矩阵转换为长格式以用于绘图
cor_data <- melt(cor_matrix)

# 绘制热图
ggplot(cor_data, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1, 1), space = "Lab", 
                       name="Correlation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = '', y = '', title = 'Correlation Matrix Heatmap')
```

