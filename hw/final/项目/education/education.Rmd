---
title: "final-education"
author:
    - HYSM
documentclass: ctexart
geometry: "left=2.5cm,right=2cm,top=3cm,bottom=2.5cm"
output:
  pdf_document: default
  html_notebook: default
  rticles::ctex:
    fig_caption: yes
    number_sections: yes
    toc: yes
classoption: "hyperref,"
---
```{r step1, warning=FALSE}
# 加载需要的包
library(dplyr)
library(ggplot2)
library(mice)
library(caret)

# 读取需要数据集
edu <- read.csv("education.csv", stringsAsFactors = F)

# 查看数据结构
str(edu)
```
```{r step2}
# 统计概要
summary(edu)
```
```{r}
# 缺失值判断
md.pattern(edu, rotate.names = T)
```
```{r step5}
# 数据预处理
# 检测缺失值
any(is.na(edu))
```
```{r}
# 数据标准化
# numeric_vars <- c("失业率", "高教总入学率")
# edu[numeric_vars] <- scale(edu[numeric_vars])

# 列名简短
# 列名修改对应的映射字典
col_mapping <- c(
  "Countries and Areas" = "地区",
  "Latitude" = "纬度",
  "Longitude" = "经度",
  "OOSR_Pre0Primary_Age_Male" = "学前失学率男",
  "OOSR_Pre0Primary_Age_Female" = "学前失学率女",
  "OOSR_Primary_Age_Male" = "小学失学率男",
  "OOSR_Primary_Age_Female" = "小学失学率女",
  "OOSR_Lower_Secondary_Age_Male" = "初中失学率男",
  "OOSR_Lower_Secondary_Age_Female" = "初中失学率女",
  "OOSR_Upper_Secondary_Age_Male" = "高中失学率男",
  "OOSR_Upper_Secondary_Age_Female" = "高中失学率女",
  "Completion_Rate_Primary_Male" = "小学完成率男",
  "Completion_Rate_Primary_Female" = "小学完成率女",
  "Completion_Rate_Lower_Secondary_Male" = "初中完成率男",
  "Completion_Rate_Lower_Secondary_Female" = "初中完成率女",
  "Completion_Rate_Upper_Secondary_Male" = "高中完成率男",
  "Completion_Rate_Upper_Secondary_Female" = "高中完成率女",
  "Grade_2_3_Proficiency_Reading" = "23年级阅读",
  "Grade_2_3_Proficiency_Math" = "23年级数学",
  "Primary_End_Proficiency_Reading" = "小学结束阅读",
  "Primary_End_Proficiency_Math" = "小学结束数学",
  "Lower_Secondary_End_Proficiency_Reading" = "初中结束阅读",
  "Lower_Secondary_End_Proficiency_Math" = "初中结束数学",
  "Youth_15_24_Literacy_Rate_Male" = "青年识字率男",
  "Youth_15_24_Literacy_Rate_Female" = "青年识字率女",
  "Birth_Rate" = "出生率",
  "Gross_Primary_Education_Enrollment" = "小教总入学率",
  "Gross_Tertiary_Education_Enrollment" = "高教总入学率",
  "Unemployment_Rate" = "失业率"
)

# 修改列名
colnames(edu) <- col_mapping

```
```{r step4}
# 参数值意味着不同的行数: 351, 325
nrow(edu)
```

```{r step3}
# 相关性分析

require(corrplot)
library(Hmisc)

correlation <- cor(edu[, 4:29])
symnum_res <- symnum(correlation)

cor_1 <- rcorr(as.matrix(edu[, 4:29]))
M <- cor_1$r
p_mat <- cor_1$P
# tl.cex 调整字体大小
# pch.cex 调整叉叉大小
corrplot(M, type = "upper", order = "hclust", p.mat = p_mat, sig.level = 0.01, tl.cex = 0.7, pch.cex = 0.7)
```

```{r}
# 重读
edu <- read.csv("education.csv", stringsAsFactors = F)
```


```{r step6}

# 获取最后两列与其他列的相关系
enroll <- cor(edu[, 28], edu[, c(-1, -2, -3, -28)])
unemploy <- cor(edu[, 29], edu[, c(-1, -2, -3, -29)])

# 设置阈值
threshold <- 0.7

# 获取强相关的列号
(enroll_related_idx <- which(abs(enroll) > threshold))
(unemploy_related_idx <- which(abs(unemploy) > threshold))
```
```{r step7}
# 使用相关性强的构建入学率的回归模型
enroll_related_col <- edu[, c(enroll_related_idx, 28)]

enroll_model <- lm(Gross_Tertiary_Education_Enrollment~., data = enroll_related_col)
enroll_model$coefficients
(enroll_sum = summary(enroll_model))
enroll_sum$coefficients
```
```{r}
# 诊断
par(mfrow=c(2,2))
plot(enroll_model) 
# 4. qq残差图看出正态性不错的，在45度斜率的直线上
# 1. Residuals vs Fitted（残差 vs 预测值）图：该图用来检查模型中的残差是否随着预测值的增加而呈现出某种模式或系统性的变化。如果残差在预测值上呈现出随机分布、无明显模式和规律，那么模型的拟合效果通常是良好的。不过，如果在图中发现明显的曲线形状、漏斗形状或者其他规律性模式，那可能意味着模型存在问题（如非线性关系、异方差性等）。

# 2. Scale-Location（标准化残差的平方根 vs 预测值）图：该图用于诊断模型中的异方差性（即残差方差是否与预测值相关）。如果图中标准化残差的平方根在预测值上呈现出随机分布、无明显模式和规律，那么可以认为模型满足异方差性的假设。然而，如果图中出现明显的漏斗形状、梯形形状或其他模式，那可能表示模型存在异方差性，需要进一步调整模型。

# 3. Residuals vs Leverage（残差 vs 杠杆值）图：该图用于识别数据点对回归模型的影响程度。在该图中，残差表示误差的大小，杠杆值表示数据点在自变量空间中的相对位置。如果数据点在图中具有高杠杆值，同时对应着较大的残差，那可能是一个“高杠杆点”或“杠杆杆点”，需进一步分析这些点是否对回归系数估计产生较大影响。
```

```{r step8}
# 使用相关性强的构建失业率的回归模型
unemploy_related_col <- edu[, c(unemploy_related_idx, 29)]

unemploy_model <- lm(Unemployment_Rate~., data = unemploy_related_col)
unemploy_model$coefficients
(unemploy_sum = summary(unemploy_model))
unemploy_sum$coefficients
```
```{r}
# 数据划分
set.seed(123)
split <- createDataPartition(edu$Gross_Primary_Education_Enrollment, p = 0.7, list = F)
train_data <- edu[split, ]
test_data <- edu[-split, ]
```
```{r}
# 利用car包
library(car)
```
```{r}
qqPlot(enroll_model, simulate = T)
```
```{r}
residplot <- function(fit, nbreaks=10) {
 z <- rstudent(fit)
 hist(z, breaks=nbreaks, freq=FALSE,
 xlab="Studentized Residual",
 main="Distribution of Errors")
 rug(jitter(z), col="brown")
 curve(dnorm(x, mean=mean(z), sd=sd(z)),
 add=TRUE, col="blue", lwd=2)
 lines(density(z)$x, density(z)$y,
 col="red", lwd=2, lty=2)
 legend("topright",
 legend = c( "Normal Curve", "Kernel Density Curve"),
 lty=1:2, col=c("blue","red"), cex=.7)
 }
```
```{r}
residplot(enroll_model)
# 出问题，均值不在0这
```

```{r}
# 独立性
durbinWatsonTest(enroll_model)
# p值不显著，无自相关，但是这个lag表示每个数据都和后一个比较，适用于时间独立的数据
```

```{r}
# 验证是否确实线性
crPlots(enroll_model)
```
```{r}
# 检验误差方差是否恒定
ncvTest(enroll_model)
# 不显著 -> 恒定
spreadLevelPlot(enroll_model)
```

