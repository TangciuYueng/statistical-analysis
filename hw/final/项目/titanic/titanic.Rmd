---
title: "final-titanic"
author:
  - "2154177 何应豪"
  - "2151298 杨滕超"
  - "2151299 苏家铭"
  - "2151294 马威"
documentclass: ctexart
geometry: "left=2.5cm, right=2cm, top=3cm, bottom=1cm"
output:
  rticles::ctex:
    fig_caption: yes
    number_sections: yes
    toc: yes
---
# 研究问题和假设
## 背景
泰坦尼克号的沉没是历史上最著名的沉船事故之一。1912年4月15日，在处女航中，被认为“永不沉没”的皇家邮轮泰坦尼克号与冰山相撞后沉没。不幸的是，船上没有足够的救生艇容纳所有人，导致2224名乘客和船员中的1502人死亡。
尽管全世界依然沉浸在惨烈的事故所带来的伤痛当中，但是有一些人却认为虽然生存有一些运气因素，但似乎有些群体比其他群体更有可能生存下来，因此他们尽可能收集到了一些乘客数据（无论是否已故），想看看什么样的人更有可能存活下来。
我们很幸运地获取到了这些数据，希望通过乘客信息建立分类预测模型，尝试解答“什么样的人更有可能活下来”的迷思。

## 现有研究
已搜集到近 900 名乘客的信息，包括舱位等级、姓名、性别、年龄、同乘兄弟姐妹/配偶数量、票价、登船港口等。是否存活是一个二分类变量，0为死亡，1为存活。

## 研究问题
什么样的人更有可能活下来？

## 研究假设
1. 你敢假定？

# 数据分析方法选择
1. 本实验需要进行预测，因变量是否存活是一个“0/1”二分类问题，且有多个解释变量。适合使用广义线性回归建立预测模型

# 基础分析
## 准备工作
```{r preparation, message=FALSE, warning=FALSE}
# 导入必要的包
library(caret)    # 生成训练集和测试集
library(ROCR)     # glm
library(pROC)     # ROC面积计算
library(ggplot2)  # 画图
library(mice)     # 缺失值可视化

# 清除当前镜像中的数据
rm(list = ls())

# 导入数据
data <- read.csv("titanic.csv")

# 预处理判断
md.pattern(data, rotate.names = TRUE)   # 检测缺失值
print(length(which(duplicated(data))))  # 检测重复行
```
## 数据预处理
### 处理缺失值
```{r pretreatment}
# 年龄（缺失形式：NA）
data$Age[is.na(data$Age)] <- mean(data$Age, na.rm = TRUE)  # 使用平均值填充

# 登船港口（缺失形式：""）
freq.table <- table(data$Embarked)  # 使用table函数计算频数
mode <- names(freq.table)[which.max(freq.table)]  # 找到频数最大的元素（众数）
data$Embarked[nchar(data$Embarked) == 0] <- mode  # 使用众数填补
rm(freq.table)
rm(mode)
```

### 数据规范
```{r standardization}
data$Fare <- scale(data$Fare)  # 票价过于分散，因此进行规范处理
```

### 指定因子水平
```{r factor}
data$Survived <- as.factor(data$Survived)  # 是否存活
data$Sex <- as.factor(data$Sex)            # 性别
data$Embarked <- as.factor(data$Embarked)  # 登船港口
```

## 初步分析
```{r basic analysis, results='hold', fig.show='hold', warning=FALSE}
# 选取所需数据进行初步分析
data <- data[, c("Survived", "Pclass", "Sex", "Age", "SibSp", "Fare", "Embarked")]
summary(data)

# 各因素的可视化
# 舱位等级
ggplot(data, aes(x = Pclass, fill = factor(Survived))) +
  geom_bar(binwidth = 1, position = "stack", stat = "bin", alpha = 0.5) +
  geom_text(
    stat = "count",
    aes(label = stat(count)),
    position = position_stack(vjust = 0.5),
    size = 3
  )
ggplot(data, aes(x = Pclass, fill = factor(Survived))) +
  geom_bar(binwidth = 1, position = "fill", stat = "bin", alpha = 0.5)

# 性别
ggplot(data, aes(x = Sex, fill = factor(Survived))) +
  geom_bar(position = "stack", alpha = 0.5) +
  geom_text(
    stat = "count",
    aes(label = stat(count)),
    position = position_stack(vjust = 0.5),
    size = 3
  )
ggplot(data, aes(x = Sex, fill = factor(Survived))) +
  geom_bar(position = "fill", alpha = 0.5)

# 年龄
ggplot(data, aes(x = Age, fill = factor(Survived))) +
  geom_bar(binwidth = 2, position = "stack", stat = "bin", alpha = 0.5) +
  geom_text(
    stat = "count",
    aes(label = stat(count)),
    position = position_stack(),
    size = 1
  )
ggplot(data, aes(x = Age, fill = factor(Survived))) +
  geom_bar(binwidth = 2, position = "fill", stat = "bin", alpha = 0.5)

# 同乘兄弟姐妹/配偶
ggplot(data, aes(x = SibSp, fill = factor(Survived))) +
  geom_bar(binwidth = 1, position = "stack", stat = "bin", alpha = 0.5) +
  geom_text(
    stat = "count",
    aes(label = stat(count)),
    position = position_stack(vjust = 0.5),
    size = 3
  )
ggplot(data, aes(x = SibSp, fill = factor(Survived))) +
  geom_bar(binwidth = 1, position = "fill", stat = "bin", alpha = 0.5)

# 票价
ggplot(data, aes(x = Fare, fill = factor(Survived))) +
  geom_bar(binwidth = 0.2, position = "stack", stat = "bin", alpha = 0.5)
ggplot(data, aes(x = Fare, fill = factor(Survived))) +
  geom_bar(binwidth = 0.2, position = "fill", stat = "bin", alpha = 0.5)

# 登船港口
ggplot(data, aes(x = Embarked, fill = factor(Survived))) +
  geom_bar(position = "stack", alpha = 0.5) +
  geom_text(
    stat = "count",
    aes(label = stat(count)),
    position = position_stack(vjust = 0.5),
    size = 3
  )
ggplot(data, aes(x = Embarked, fill = factor(Survived))) +
  geom_bar(position = "fill", alpha = 0.5)
```

# 主要分析
## 进行数据划分
```{r data divide}
set.seed(123)
split <- createDataPartition(data$Survived, p = 0.7, list = FALSE)
train_data <- data[split, ]  # 训练集
test_data <- data[-split, ]  # 测试集
```
## 建立预测模型（全因素）
```{r model 1}
model <- glm(Survived ~ ., data = train_data, family = binomial)
summary(model)
```
## 建立预测模型（显著影响因素）
```{r model 2}
model <- glm(Survived ~ Pclass+Sex+Age+SibSp+Embarked, data = train_data, family = binomial)
summary(model)
```
## 模型评估
```{r evaluation, results='hold', fig.show='hold'}
pred <- predict(model, test_data, type = "response")
auc <- roc(test_data$Survived, pred)
auc$auc
pred <- prediction(pred, test_data$Survived)
plot(performance(pred, "tpr", "fpr"), colorize = T, lwd = 3, main = "ROC curve")
abline(a = 0, b = 1, lty = 2, lwd = 3, col = "black")
```

# 分析结果解读

## 对生存率的各影响因素（由于1为生存，所以将odds称为生存几率）：
```{r coefficients}
print(exp(model$coefficients))
```

### 舱位等级
- **预测：** 每下降一级（等级数+1），生存几率**降为**原来的**0.286倍**
- **解读：** 能坐到更高等级舱位的人可能会有更高的地位，在紧急情况下就有可能被“优待”得更多。也可能是富人并没有参与救生艇的共同分配，能自己搞到救生艇提前逃跑。

### 性别
- **预测：** 为男性时，生存几率**降为**原来的**0.056倍**
- **解读：** 女士优先

### 年龄
- **预测：** 每大一岁，生存几率**降为**原来的**0.961倍**
- **解读：** 小孩优先

### 同乘兄弟姐妹/配偶数量
- **预测：** 每多1个，生存几率**降为**原来的**0.714倍**
- **解读：** 落单的人优先

### 登船港口
- **预测：** 在S港（Southampton）登船时，生存几率**降为**原来的**0.452倍**
- **解读：** 在南安普顿港登船的人可能社会阶级更高，也可能是在登船港口进行缺失值处理时进行了众数填补，从而导致了更多生还的人被划入S港登船人群

## 总结
1. 就搜集到的数据以及生成的预测模型上看，的确一些因素对于生存率有显著影响
2. 高等级舱位/女性/年轻人/落单/不在Southampton登船，满足以上部分因素的人更有可能活下来
3. 在主要分析中生成的模型里，仅保留显著影响因素的模型AIC值较小，因此选择它进行后续评估分析。其AUC值为0.817 > 0.8，测试集结果说明，该模型具有相对较好的分类能力
4. 总而言之，现在再回头分析“哪些人更有可能活下来”这类问题，我们可以窥视到历史上一场惨烈事故中的众生百态：舍己为人、尔虞我诈、争先恐后、绝望等待......同样，也可以看到当时社会的一些价值观体现。但今时不同以往，了解到这段历史的沉痛后，在新的社会环境下，随着航海技术、人们的观念等发生改变，或许这类问题有了重新研究的价值。但我们更希望的是事故永远不会发生，大家平平安安，一帆风顺。